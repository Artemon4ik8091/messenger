# Документация Backend Мессенджера (Flask API)

Эта документация описывает настройку, установку и использование backend API для мессенджера, разработанного на Flask.
---

## 1. Введение

Этот проект представляет собой backend API для простого мессенджера, построенный с использованием фреймворка Flask. Он предоставляет функциональность для управления пользователями, создания различных типов чатов (приватных, групповых, каналов), управления участниками и отправки/получения сообщений, включая файловые вложения. В качестве базы данных используется SQLite.

## 2. Требования

Для запуска проекта вам потребуется:

* **Python 3.8+**
* **pip** (менеджер пакетов Python)

## 3. Настройка проекта

Следуйте этим шагам для настройки и подготовки проекта к запуску.

### Установка зависимостей

После активации виртуального окружения установите необходимые пакеты из `requirements.txt` (если он есть, или вручную).
В данном проекте используются следующие библиотеки:

```bash
pip install Flask Flask-SQLAlchemy Werkzeug python-dotenv
```

  * `Flask`: Основной фреймворк для веб-приложения.
  * `Werkzeug`: Набор утилит WSGI, используемых Flask, в частности для хеширования паролей.
  * `python-dotenv`: Для загрузки переменных окружения из файла `.env`.

### Переменные окружения

Создайте файл `.env` в корневой директории проекта (там же, где `app.py`, `config.py` и `database.py`). Этот файл будет содержать настройки, которые не должны быть частью вашего кода, например, секретные ключи.

```dotenv
# .env

DATABASE_PATH=messenger.db
SECRET_KEY=your_super_secret_key_change_me_to_a_long_random_string
```

  * `DATABASE_PATH`: Путь к файлу базы данных SQLite. По умолчанию `messenger.db` будет создан в корне проекта.
  * `SECRET_KEY`: **ОЧЕНЬ ВАЖНО\!** Замените `your_super_secret_key_change_me_to_a_long_random_string` на длинную, случайную, уникальную строку. Этот ключ используется Flask для защиты сессий и других криптографических операций. Вы можете сгенерировать его, например, так: `python -c 'import os; print(os.urandom(24).hex())'`

## 4\. Инициализация базы данных

База данных SQLite должна быть инициализирована для создания всех необходимых таблиц. Используйте команду Flask CLI:

Убедитесь, что ваше виртуальное окружение активировано.

```bash
flask --app app init-db
```

Эта команда выполнит SQL-скрипт из файла `schema.sql`, который создаст все таблицы (users, chats, messages и т.д.) и индексы. **Внимание:** Если база данных уже существует, эта команда удалит все существующие таблицы и создаст их заново, что приведет к потере всех данных\!

## 5\. Запуск сервера

После настройки и инициализации базы данных вы можете запустить сервер Flask:

Убедитесь, что ваше виртуальное окружение активировано.

```bash
flask --app app run --host=0.0.0.0 --port=5125 --debug
```

  * `--app app`: Указывает Flask, что ваше приложение находится в файле `app.py`.
  * `--host=0.0.0.0`: Делает сервер доступным извне (не только с вашей локальной машины).
  * `--port=5125`: Указывает порт, на котором будет запущен сервер.
  * `--debug`: Включает режим отладки, который предоставляет более подробные сообщения об ошибках и автоматически перезагружает сервер при изменениях в коде. **Никогда не используйте `--debug` в production окружении\!**

Сервер будет доступен по адресу `http://127.0.0.1:5125` (или `http://ВАШ_IP_АДРЕС:5125`, если вы запускаете его на удаленной машине с `--host=0.0.0.0`).

## 6\. Структура проекта

  * `app.py`: Основной файл приложения Flask. Содержит определение маршрутов API, логику обработки запросов и запускает сервер.
  * `config.py`: Файл конфигурации, содержащий переменные приложения, такие как путь к базе данных, секретный ключ и настройки для загрузки файлов.
  * `database.py`: Модуль, отвечающий за взаимодействие с базой данных SQLite. Содержит функции для получения и закрытия соединения с БД, а также для инициализации схемы.
  * `schema.sql`: SQL-скрипт, содержащий DDL (Data Definition Language) запросы для создания всех таблиц в базе данных.
  * `.env`: (Не включен в репозиторий, создается вручную) Файл для хранения переменных окружения.
  * `uploads/`: (Будет создан автоматически) Папка для хранения загруженных файлов.

## 7\. API Эндпоинты

Все эндпоинты API начинаются с префикса `/api`. Некоторые эндпоинты требуют аутентификации (отмечены `(Требуется аутентификация)`).

### В папке проекта есть кое какой клиент. Можно его использовать.
---

### Пользователи

  * **`POST /api/register`**
      * **Описание:** Регистрация нового пользователя.
      * **Тело запроса (JSON):**
        ```json
        {
            "username": "newuser",
            "password": "securepassword123",
            "display_name": "Новый Пользователь" (опционально)
        }
        ```
      * **Ответ:** `201 Created` или `400 Bad Request`, `409 Conflict`, `500 Internal Server Error`.
  * **`POST /api/login`**
      * **Описание:** Вход пользователя в систему. Устанавливает сессионную куку.
      * **Тело запроса (JSON):**
        ```json
        {
            "username": "existinguser",
            "password": "theirpassword"
        }
        ```
      * **Ответ:** `200 OK` или `400 Bad Request`, `401 Unauthorized`, `403 Forbidden`, `500 Internal Server Error`.
  * **`POST /api/logout` (Требуется аутентификация)**
      * **Описание:** Выход пользователя из системы. Очищает сессию.
      * **Ответ:** `200 OK`.
  * **`GET /api/users/profile` (Требуется аутентификация)**
      * **Описание:** Получение профиля текущего аутентифицированного пользователя.
      * **Ответ:** `200 OK` с данными профиля или `401 Unauthorized`.
  * **`PUT /api/users/profile` (Требуется аутентификация)**
      * **Описание:** Обновление профиля текущего пользователя (display\_name, email, avatar\_url).
      * **Тело запроса (JSON):**
        ```json
        {
            "display_name": "Новое Имя",
            "email": "new.email@example.com",
            "avatar_url": "[http://example.com/new_avatar.jpg](http://example.com/new_avatar.jpg)"
        }
        ```
        (Поля опциональны, но должно быть хотя бы одно).
      * **Ответ:** `200 OK` или `400 Bad Request`, `401 Unauthorized`, `409 Conflict`, `500 Internal Server Error`.
  * **`PUT /api/users/password` (Требуется аутентификация)**
      * **Описание:** Обновление пароля текущего пользователя.
      * **Тело запроса (JSON):**
        ```json
        {
            "current_password": "securepassword123",
            "new_password": "newsecurepassword456"
        }
        ```
      * **Ответ:** `200 OK` или `400 Bad Request`, `401 Unauthorized`, `500 Internal Server Error`.
  * **`POST /api/users/delete` (Требуется аутентификация)**
      * **Описание:** Мягкое удаление аккаунта пользователя (помечается как удаленный, данные пользователя скрываются/сбрасываются).
      * **Ответ:** `200 OK`.
  * **`GET /api/users/search?query=<search_term>` (Требуется аутентификация)**
      * **Описание:** Поиск пользователей по username или display\_name.
      * **Параметры запроса:**
          * `query`: Строка для поиска (например, `?query=john`).
      * **Ответ:** `200 OK` с массивом найденных пользователей.

### Чаты

  * **`POST /api/chats/private` (Требуется аутентификация)**
      * **Описание:** Создание приватного чата с другим пользователем.
      * **Тело запроса (JSON):**
        ```json
        {
            "target_username": "otheruser"
        }
        ```
      * **Ответ:** `201 Created` с `chat_id` или `400 Bad Request`, `404 Not Found`, `409 Conflict`, `500 Internal Server Error`.
  * **`POST /api/chats/group` (Требуется аутентификация)**
      * **Описание:** Создание группового чата. Создатель становится админом.
      * **Тело запроса (JSON):**
        ```json
        {
            "name": "Моя Команда",
            "member_usernames": ["user1", "user2"] (опционально)
        }
        ```
      * **Ответ:** `201 Created` с `chat_id` или `400 Bad Request`, `500 Internal Server Error`.
  * **`POST /api/chats/channel` (Требуется аутентификация)**
      * **Описание:** Создание канала. Создатель становится владельцем.
      * **Тело запроса (JSON):**
        ```json
        {
            "name": "Новости IT",
            "avatar_url": "[http://example.com/channel_icon.png](http://example.com/channel_icon.png)" (опционально)
        }
        ```
      * **Ответ:** `201 Created` с `chat_id` или `400 Bad Request`, `500 Internal Server Error`.
  * **`GET /api/chats` (Требуется аутентификация)**
      * **Описание:** Получение списка всех чатов, в которых участвует текущий пользователь.
      * **Ответ:** `200 OK` с массивом чатов.
  * **`GET /api/chats/<int:chat_id>` (Требуется аутентификация)**
      * **Описание:** Получение подробной информации о конкретном чате (только если пользователь является участником/подписчиком).
      * **Параметры пути:**
          * `chat_id`: ID чата.
      * **Ответ:** `200 OK` с деталями чата или `403 Forbidden`, `404 Not Found`.
  * **`PUT /api/chats/<int:chat_id>` (Требуется аутентификация)**
      * **Описание:** Обновление информации о групповом чате или канале (имя, аватар).
      * **Права:** Только администраторы групп или владельцы каналов.
      * **Параметры пути:**
          * `chat_id`: ID чата.
      * **Тело запроса (JSON):**
        ```json
        {
            "name": "Новое имя чата",
            "avatar_url": "[http://example.com/new_chat_icon.png](http://example.com/new_chat_icon.png)"
        }
        ```
      * **Ответ:** `200 OK` или `400 Bad Request`, `403 Forbidden`, `404 Not Found`, `500 Internal Server Error`.
  * **`DELETE /api/chats/<int:chat_id>` (Требуется аутентификация)**
      * **Описание:** Удаление чата.
      * **Права:**
          * Приватный чат: любой из двух участников.
          * Группа: администратор группы.
          * Канал: владелец канала.
      * **Параметры пути:**
          * `chat_id`: ID чата.
      * **Ответ:** `200 OK` или `403 Forbidden`, `404 Not Found`, `500 Internal Server Error`.

### Управление участниками групп и каналов

  * **`POST /api/groups/<int:group_id>/members` (Требуется аутентификация)**
      * **Описание:** Добавление нового участника в группу.
      * **Права:** Только администраторы группы.
      * **Параметры пути:**
          * `group_id`: ID группы.
      * **Тело запроса (JSON):**
        ```json
        {
            "username": "new_member_username",
            "role": "member" (опционально, 'admin', 'member', 'restricted')
        }
        ```
      * **Ответ:** `201 Created` или `400 Bad Request`, `403 Forbidden`, `404 Not Found`, `409 Conflict`, `500 Internal Server Error`.
  * **`PUT /api/groups/<int:group_id>/members/<int:target_user_id>` (Требуется аутентификация)**
      * **Описание:** Изменение роли участника в группе.
      * **Права:** Только администраторы группы. Нельзя понизить свою роль, если вы единственный админ.
      * **Параметры пути:**
          * `group_id`: ID группы.
          * `target_user_id`: ID пользователя, чью роль нужно изменить.
      * **Тело запроса (JSON):**
        ```json
        {
            "role": "admin"
        }
        ```
      * **Ответ:** `200 OK` или `400 Bad Request`, `403 Forbidden`, `404 Not Found`, `500 Internal Server Error`.
  * **`DELETE /api/groups/<int:group_id>/members/<int:target_user_id>` (Требуется аутентификация)**
      * **Описание:** Удаление участника из группы.
      * **Права:** Только администраторы группы. Нельзя удалить себя, если вы единственный админ.
      * **Параметры пути:**
          * `group_id`: ID группы.
          * `target_user_id`: ID пользователя, которого нужно удалить.
      * **Ответ:** `200 OK` или `400 Bad Request`, `403 Forbidden`, `404 Not Found`, `500 Internal Server Error`.
  * **`POST /api/channels/<int:channel_id>/subscribers` (Требуется аутентификация)**
      * **Описание:** Добавление подписчика в канал.
      * **Права:** Только владелец канала.
      * **Параметры пути:**
          * `channel_id`: ID канала.
      * **Тело запроса (JSON):**
        ```json
        {
            "username": "new_subscriber_username"
        }
        ```
      * **Ответ:** `201 Created` или `400 Bad Request`, `403 Forbidden`, `404 Not Found`, `409 Conflict`, `500 Internal Server Error`.
  * **`POST /api/channels/<int:channel_id>/subscribe` (Требуется аутентификация)**
      * **Описание:** Подписка текущего пользователя на канал.
      * **Права:** Любой аутентифицированный пользователь.
      * **Параметры пути:**
          * `channel_id`: ID канала.
      * **Ответ:** `201 Created` или `404 Not Found`, `409 Conflict`, `500 Internal Server Error`.
  * **`DELETE /api/channels/<int:channel_id>/unsubscribe` (Требуется аутентификация)**
      * **Описание:** Отписка текущего пользователя от канала.
      * **Права:** Любой аутентифицированный пользователь, кроме владельца канала. Владелец должен использовать DELETE /api/chats/\<id\>.
      * **Параметры пути:**
          * `channel_id`: ID канала.
      * **Ответ:** `200 OK` или `403 Forbidden`, `404 Not Found`, `500 Internal Server Error`.

### Сообщения

  * **`POST /api/chats/<int:chat_id>/messages` (Требуется аутентификация)**
      * **Описание:** Отправка сообщения (текстового или файла) в чат.
      * **Права:**
          * Приватные чаты: оба участника.
          * Группы: администраторы и обычные участники.
          * Каналы: только владелец канала.
      * **Параметры пути:**
          * `chat_id`: ID чата.
      * **Тело запроса:**
          * **Для текстового сообщения (JSON):**
            ```json
            {
                "content": "Привет, как дела?"
            }
            ```
          * **Для файлового сообщения (FormData):**
            ```
            Content-Type: multipart/form-data
            file: <ваш файл>
            ```
      * **Ответ:** `201 Created` с `message_id` или `400 Bad Request`, `403 Forbidden`, `404 Not Found`, `413 Payload Too Large` (для файлов), `500 Internal Server Error`.
  * **`GET /api/chats/<int:chat_id>/messages` (Требуется аутентификация)**
      * **Описание:** Получение списка сообщений из чата.
      * **Права:** Только участники/подписчики чата.
      * **Параметры пути:**
          * `chat_id`: ID чата.
      * **Ответ:** `200 OK` с массивом сообщений.
  * **`DELETE /api/messages/<int:message_id>` (Требуется аутентификация)**
      * **Описание:** Мягкое удаление сообщения. Сообщение помечается как удаленное, и его содержимое скрывается.
      * **Права:**
          * Отправитель сообщения.
          * Администратор группы (для сообщений в группах).
          * Владелец канала (для сообщений в каналах).
      * **Параметры пути:**
          * `message_id`: ID сообщения.
      * **Ответ:** `200 OK` или `403 Forbidden`, `404 Not Found`, `500 Internal Server Error`.

### Загруженные файлы

  * **`GET /uploads/<path:filename>`**
      * **Описание:** Доступ к загруженным файлам.
      * **Параметры пути:**
          * `filename`: Уникальное имя файла, возвращенное при загрузке.
      * **Ответ:** Файл или `404 Not Found`.

## 8\. Обработка ошибок

API возвращает стандартные HTTP-статусы ошибок и JSON-объекты с полем `error`, содержащим описание проблемы.

Примеры:

  * `400 Bad Request`: Некорректные входные данные.
  * `401 Unauthorized`: Требуется аутентификация.
  * `403 Forbidden`: Недостаточно прав для выполнения операции.
  * `404 Not Found`: Запрошенный ресурс не найден.
  * `409 Conflict`: Конфликт данных (например, пользователь с таким именем уже существует).
  * `500 Internal Server Error`: Неожиданная ошибка на сервере.

## 9\. Безопасность

  * **Хеширование паролей:** Пароли пользователей хешируются с использованием `werkzeug.security.generate_password_hash` перед сохранением в базу данных.
  * **Сессионные куки:** Для аутентификации используется сессия Flask, которая хранится в подписанных куки. **Обязательно используйте сильный `SECRET_KEY`\!**
  * **Мягкое удаление:** Пользователи и сообщения мягко удаляются (помечаются как удаленные), чтобы сохранить целостность данных, ссылающихся на них, и избежать немедленного удаления всей связанной информации.
  * **Проверка прав доступа:** Перед каждой операцией проверяются права текущего аутентифицированного пользователя на выполнение запрошенного действия.
  * **Загрузка файлов:** Проверяются разрешенные расширения файлов, а уникальные имена файлов генерируются для предотвращения перезаписи и обхода пути.